---

- name: OpenVPN | Setup | Adding repository key
  ansible.builtin.apt_key:
    url: "{{ OVPN_HC.repo.gpg }}"
    state: present

- name: OpenVPN | Setup | Adding repository
  ansible.builtin.apt_repository:
    repo: "deb {{ OVPN_HC.repo.url }} {{ ansible_distribution_release }} main"
    state: present
    update_cache: true
    filename: 'openvpn'

- name: OpenVPN | Setup | Installing dependencies
  ansible.builtin.package:
    name: ['openssl', 'python3-pexpect']
    state: present

- name: OpenVPN | Setup | Installing
  ansible.builtin.package:
    name: "openvpn{% if OVPN_CONFIG.version != 'latest' %}={{ OVPN_CONFIG.version }}{% endif %}"
    state: present

- name: OpenVPN | Setup | Creating service user
  ansible.builtin.user:
    name: "{{ OVPN_HC.user }}"
    shell: '/sbin/nologin'

- name: OpenVPN | Setup | Adding capabilities to bind to system-ports (<1024)
  community.general.capabilities:
    path: '/usr/sbin/openvpn'
    capability: 'cap_net_bind_service+eip'
    state: present
  changed_when: false

- name: OpenVPN | Setup | Adding directories \#1
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: "{{ OVPN_HC.user }}"
    group: "{{ OVPN_HC.user }}"
    mode: 0755
  loop:
    - "{{ OVPN_CONFIG.path.base }}"
    - "{{ OVPN_HC.path.run }}"

- name: OpenVPN | Setup | Adding directories \#2
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: "{{ OVPN_HC.user }}"
    group: "{{ OVPN_HC.user }}"
    mode: 0750
  loop:
    - "{{ OVPN_CONFIG.path.lib }}"
    - "{{ OVPN_CONFIG.path.script }}"
    - "{{ OVPN_CONFIG.path.log }}"

- name: OpenVPN | Setup | Adding directories \#3
  ansible.builtin.file:
    state: directory
    path: "{{ item }}"
    owner: 'root'
    group: 'root'
    mode: 0755
  loop:
    - "/etc/systemd/system/openvpn@.service.d"

- name: OpenVPN | Setup | Removing directories
  ansible.builtin.file:
    state: absent
    path: "{{ item }}"
  loop:
    - "{{ OVPN_CONFIG.path.base }}/client"
    - "{{ OVPN_CONFIG.path.base }}/server"

- name: OpenVPN | Setup | Service override
  ansible.builtin.template:
    src: 'templates/etc/systemd/system/openvpn@.service.d/override.conf.j2'
    dest: '/etc/systemd/system/openvpn@.service.d/override.conf'
    owner: 'root'
    group: 'root'
    mode: 0644
  register: ovpn_override_config  # todo: restart with prompt

- name:  OpenVPN | Setup | Adding user privileges
  ansible.builtin.template:
    src: 'templates/etc/sudoers.d/openvpn.j2'
    dest: '/etc/sudoers.d/openvpn'
    validate: '/usr/sbin/visudo -cf %s'
    mode: 0640
    owner: 'root'
    group: 'root'

- name: OpenVPN | Setup | Copying scripts
  ansible.builtin.template:
    src: "templates/usr/local/bin/openvpn/{{ item }}.j2"
    dest: "{{ OVPN_CONFIG.path.script }}/{{ item }}"
    owner: 'root'
    group: "{{ OVPN_HC.user }}"
    mode: 0750
  loop:
    - 'iproute_wrapper.sh'

- name: OpenVPN | Setup | Systemd Daemon-Reload
  ansible.builtin.systemd:
    daemon_reload: true
  when: ovpn_override_config.changed

